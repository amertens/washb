---
title: "Wash Benefits internal R package functions"
author: "Andrew Mertens"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{washb-package-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r set-options, echo=FALSE, cache=FALSE}
options(width = 200)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# WASH Benefits diarrheal disease outcome analysis using R package functions  
### Calculate adjusted differences in diarrheal disease between treatment arms for H1 and H2  
  
###Input file:
 * washb-bangladesh-diar.csv  
 
###List and description of the functions documented in this vignette:  
 * __washb_prescreen:__ Function to pre-screen adjustment covariates -- restrict to those with a LR test P<0.2.  
 * __washb_permute:__ Conducts a permutation test of the indepdence of Y and tr, conditional on randomization block using the Wilcoxon rank-sum test statistic.
 * __washb_glm:__ Convenience wrapper function to run glm models with robust standard errors for unadjusted and adjusted estimates.
 * __washb_means:__  Means estimated with robust standard errors for the WASH Benefits trials. Calculate means for a variable along with robust sandwich SEs and 95\% confidence intervals that account for clustering within id.
 * __sandwichSE__ 
 * __washb_ttest:__ Wrapper function to call the paired t-test for two different arms of the study.  
 * __washb_mh.pool:__ Estimates the Mantel-Haenszel prevalence ratio. Note: strata with no outcomes (i.e., missing PR) are dropped. This is consistent with a fixed-effects regression analysis, in which those strata would not contribute to the estimates. The arguments Y,tr,strat, below need to be from the same dataset.
 * __washb_prescreen__ 
 * __washb_ITT.unadj:__ Unadjusted ITT estimates of differences between arms, calculated with either a paired T-test (continuous outcomes) or a Mantel-Haenszel pooled estimator (binary outcomes). The arguments Y,tr,strat, below need to be from the same dataset.

 
###Relationships among functions:
__washb\_glm__ calls __washb_prescreen__, and then only covariates with a p-value>0.2 are included in the adjustment set.  
__washb\_glm__ uses __sandwichSE__ to estimate sandwich-based robust standard errors to account for clustering.  
  
__washb\_ITT.unadj__ uses __washb_mh.pool__ to estimate Mantel-Haenszel pooled estimates if the outcome is binomial
__washb\_ITT.unadj__ uses __washb_ttest__ to estimate paired t-test if the outcome is continious 
  
__washb_means__ uses __sandwichSE__ to estimate sandwich-based robust standard errors to account for clustering.

 
### Load in necessary packages:
To be filled in

```{r echo=FALSE, results = "hide"}
library(washb)
rm(list=ls())
```


```{r echo=FALSE, results = "hide"}  
 baseLoc<- system.file(package="washb")  
 extPath<- file.path(baseLoc, "data")

 load(file.path(extPath, "washb_bd_enrol.Rdata"))  
 load(file.path(extPath, "washb_bd_diar.Rdata"))  
```



###Clean data  
The data in this vignette is contained in 2 files, included in the package:  
1.  __washb_bd_enrol.Rdata__, an R file of enrollment characteristics  
1.  __washb_bd_diar.Rdata__, an R file of diarrheal disease data  

```{r, tidy=TRUE}
# drop svydate and month because they are superceded in the child level diarrhea data
  washb_bd_enrol$svydate <- NULL
  washb_bd_enrol$month <- NULL

# merge the baseline dataset to the follow-up dataset
ad <- merge(washb_bd_enrol,washb_bd_diar,by=c("dataid","clusterid","block","tr"),all.x=F,all.y=T)
dim(washb_bd_diar)
dim(ad)

# subset to the relevant measurement
# Year 1 or Year 2
table(ad$svy)
ad <- subset(ad,svy==1|svy==2)
dim(ad)

#subset the diarrhea to children <36 mos at enrollment
### (exlude new births that are not target children)
dim(ad)
table(ad$sibnewbirth)
ad <- subset(ad,sibnewbirth==0)
dim(ad)
table(ad$gt36mos)
ad <- subset(ad,gt36mos==0)

# Exclude children with missing data
table(ad$tchild,is.na(ad$diar7d),ad$svy)
ad <- subset(ad,!is.na(ad$diar7d))

#Re-order the tr factor for convenience
ad$tr <- factor(ad$tr,levels=c("Control","Water","Sanitation","Handwashing","WSH","Nutrition","Nutrition + WSH"))

#Ensure that month is coded as a factor
ad$month <- factor(ad$month)

#Sort the data for perfect replication when using V-fold cross-validation
ad <- ad[order(ad$block,ad$clusterid,ad$dataid,ad$childid),]
```

#Function: wasb_prescreen  
Select covariates with univariate associations with the outcome of P<0.2 based on a likelihood ratio test.
 * (Excluded because only measured in target children: birthord)  
 * (Dropped due to too many missing values: asset_clock, momheight)  

###First, subset the desired variables
```{r  echo=FALSE}

Ws <- subset(ad,select=c("fracode","month","agedays","sex","momage","momedu","momheight","hfiacat","Nlt18","Ncomp","watmin","elec","floor","walls","roof","asset_wardrobe","asset_table","asset_chair","asset_khat","asset_chouki","asset_tv","asset_refrig","asset_bike","asset_moto","asset_sewmach","asset_mobile"))
```

###Run the washb_prescreen function
```{r, results="hide"}
washb_prescreen(Y=ad$diar7d,Ws,family="poisson")
```

###Estimate adjusted mean differences

#H1: Each intervention arm vs. Control  
###Create vector of contrasts
```{r}
h1.contrasts <- list(
  c("Control","Water"),
  c("Control","Sanitation"),
  c("Control","Handwashing"),
  c("Control","WSH"),
  c("Control","Nutrition"),
  c("Control","Nutrition + WSH")
)
```
### Unadjusted estimates (Mantel-Haenszel)
```{r}
diff.h1 <- t(sapply(h1.contrasts,washb_ITT.unadj,Y=ad$diar7d,tr=ad$tr,strat=ad$block,binomial=TRUE,measure="RR"))
rownames(diff.h1) <- c("Water v C","Sanitation v C","Handwashing v C","WSH v C","Nutrition v C","Nutrition + WSH v C")
print(exp(diff.h1))
```

### Non-parametric unadjusted estimates (Wilcoxon Signed Rank permutation test)
```{r, eval = FALSE, tidy=TRUE}
##Need to fix so code runs
permute.diff.h1<-t(sapply(h1.contrasts,washb_permute, Y=ad$diar7d, tr=ad$tr, pair=ad$block, nreps=10000, seed=12345))
rownames(diff.h1) <- c("Water v C","Sanitation v C","Handwashing v C","WSH v C","Nutrition v C","Nutrition + WSH v C")
```


#Adjusted TMLE Estimates
###(Not Run)

```{r, eval = FALSE, tidy=TRUE}
# adjusted estimates (tmle)
cwfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Water"),seed=3902288)
csfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Sanitation"),seed=6125274)
chfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Handwashing"),seed=4499261)
cwshfit  <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","WSH"),seed=4545085)
cnfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Nutrition"),seed=1964134)
cwshnfit <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Nutrition + WSH"),seed=4397157)

# pull out the estimates from the tmle objects and summarize them in a matrix
tmle.summary.rd <- function(x) {
  res <- c(x$estimates$ATE$psi,x$estimates$ATE$CI[1],x$estimates$ATE$CI[2],x$estimates$ATE$pvalue)
  names(res) <- c("rd","ci.lb","ci.ub","p")
  return(res)
}
tmle.summary.pr <- function(x) {
  res <- c(x$estimates$RR$psi,x$estimates$RR$CI[1],x$estimates$RR$CI[2],x$estimates$RR$pvalue)
  names(res) <- c("pr","ci.lb","ci.ub","p")
  return(res)
}

tmle.h1 <- list(cwfit,csfit,chfit,cwshfit,cnfit,cwshnfit)
rd.tmle.h1 <- t(sapply(tmle.h1,tmle.summary.rd))
pr.tmle.h1 <- t(sapply(tmle.h1,tmle.summary.pr))
rownames(rd.tmle.h1) <- rownames(pr.tmle.h1) <- rownames(diff.h1)

# print results
round(diff.h1,4)
round(rd.tmle.h1,4)
round(pr.tmle.h1,4)
```

# H2: Combined WSH versus single interventions
```{r}

h2.contrasts <- list(
  c("Water","WSH"),
  c("Sanitation","WSH"),
  c("Handwashing","WSH")
)
```

```{r}

# unadjusted estimates (paired t-test)
diff.h2 <- t(sapply(h2.contrasts,washb_ITT.unadj,Y=ad$diar7d,tr=ad$tr,strat=ad$block,binomial=TRUE,measure="RR"))
rownames(diff.h2) <- c("WSH v Water","WSH v Sanitation","WSH v Handwashing")
print(exp(diff.h2))
```

```{r, eval = FALSE, tidy=TRUE}

# adjusted estimates (tmle)
wshwfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("Water","WSH"),seed=8440041)
wshhfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("Handwashing","WSH"),seed=1948434)
wshsfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("Sanitation","WSH"),seed=1289364)

tmle.h2 <- list(wshwfit,wshsfit,wshhfit)
rd.tmle.h2 <- t(sapply(tmle.h2,tmle.summary.rd))
pr.tmle.h2 <- t(sapply(tmle.h2,tmle.summary.pr))
rownames(rd.tmle.h2) <- rownames(pr.tmle.h2) <- rownames(diff.h2)

# print results
round(diff.h2,4)
round(rd.tmle.h2,4)
round(pr.tmle.h2,4)
```

# H3: WSH+Nutrition vs. WSH or Nutrition alone
## Currently not run to save computing time B/C Not Pre-specified for diarrhea
```{r, eval = FALSE, tidy=TRUE}

 h3.contrasts <- list(
   c("WSH","Nutrition + WSH"),
   c("Nutrition","Nutrition + WSH")
 )
 
 # unadjusted estimates (paired t-test)
 diff.h3 <- t(sapply(h3.contrasts,ITT.unadj,Y=ad$diar7d,tr=ad$tr,strat=ad$block))
 rownames(diff.h3) <- c("Nutrition + WSH v Nutrition","Nutrition + WSH v WSH")
 
 # adjusted estimates (tmle)
 set.seed(792348)
 wshwshnfit <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("WSH","Nutrition + WSH"))
 nwshnfit   <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("Nutrition","Nutrition + WSH"))
 
 tmle.h3 <- list(nwshnfit,wshwshnfit)
 rd.tmle.h3 <- t(sapply(tmle.h3,tmle.summary.rd))
 rownames(rd.tmle.h3) <- rownames(diff.h3)
```

### Re-name into pre-specified objects
```{r, eval = FALSE, tidy=TRUE}

diar_h1_rd_adj <- rd.tmle.h1
diar_h2_rd_adj <- rd.tmle.h2
# diar_h3_rd_adj <- rd.tmle.h3

diar_h1_pr_adj <- pr.tmle.h1
diar_h2_pr_adj <- pr.tmle.h2
# diar_h3_pr_adj <- pr.tmle.h3
```

# Print and save results
```{r,  eval = FALSE, tidy=TRUE}

diar_h1_rd_adj

diar_h2_rd_adj

diar_h1_pr_adj

diar_h2_pr_adj
```



#Unadjusted GLM
```{r}
print((diff.h1))
print(exp(diff.h1))

print((diff.h2))
print(exp(diff.h2))



print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Water"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Sanitation"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Handwashing"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","WSH"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Nutrition"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Nutrition + WSH"), family="binomial")))

#diff.h1 <- t(sapply(h1.contrasts,washb_ITT.unadj,Y=ad$diar7d,tr=ad$tr,strat=ad$block,binomial=TRUE,measure="RD"))
#rownames(glm.h1) <- c("Water v C","Sanitation v C","Handwashing v C","WSH v C","Nutrition v C","Nutrition + WSH v C")
#print(diff.h1)


#Need to fix/debug
#glm.h1<-washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=h1.contrasts, family="binomial")
#rownames(glm.h1) <- c("Water v C","Sanitation v C","Handwashing v C","WSH v C","Nutrition v C","Nutrition + WSH v C")
#print(glm.h1)
```

#Adjusted GLM
```{r}

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Water"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Sanitation"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Handwashing"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","WSH"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Nutrition"), family="binomial")))

print(exp(washb_glm(Y=ad$diar7d,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Nutrition + WSH"), family="binomial")))
```




#__LAZ Outcome Analysis__



# Load the analysis dataset,
# the baseline covariate dataset

```{r,  results="hide"}
load(file.path(extPath, "washb_bd_enrol.Rdata"))  
load(file.path(extPath, "washb_bd_anthro.Rdata"))  

# drop svydate and month because they are superceded in the child level diarrhea data
  washb_bd_enrol$svydate <- NULL
  washb_bd_enrol$month <- NULL

# merge the baseline dataset to the follow-up dataset
ad <- merge(washb_bd_enrol,washb_bd_anthro,by=c("dataid","clusterid","block","tr"),all.x=F,all.y=T)
dim(washb_bd_anthro)
dim(ad)

#---------------------------------------
# subset to the relevant measurement
# Year 1 or Year 2
#---------------------------------------
table(ad$svy)
ad <- subset(ad,svy==2)
dim(ad)

# subset the anthropometry to target children (excluding siblings)
dim(ad)
ad <- subset(ad,tchild=="Target child")
dim(ad)

# Drop children with extreme LAZ values
table(ad$laz_x)
ad <- subset(ad,laz_x!=1)


# Exclude children with missing data (none)
table(is.na(ad$laz))

# re-order the tr factor for convenience
ad$tr <- factor(ad$tr,levels=c("Control","Water","Sanitation","Handwashing","WSH","Nutrition","Nutrition + WSH"))

# ensure that month is coded as a factor
ad$month <- factor(ad$month)

# sort the data for perfect replication with jade on the V-fold cross-validation
ad <- ad[order(ad$block,ad$clusterid,ad$dataid,ad$childid),]

#---------------------------------------
# Select covariates with univariate
# associations with the outcome of
# P<0.2 based on a liklihood ratio test
#---------------------------------------

# drop due to so many missing values?
# asset_clock

Ws <- subset(ad,select=c("fracode","month","aged","sex","birthord","momage","momedu","momheight","hfiacat","Nlt18","Ncomp","watmin","elec","floor","walls","roof","asset_wardrobe","asset_table","asset_chair","asset_khat","asset_chouki","asset_tv","asset_refrig","asset_bike","asset_moto","asset_sewmach","asset_mobile"))


#---------------------------------------
# Estimate adjusted mean differences
#---------------------------------------
#---------------------------------------
# H1: Each intervention arm vs. Control
#---------------------------------------
h1.contrasts <- list(
  c("Control","Water"),
  c("Control","Sanitation"),
  c("Control","Handwashing"),
  c("Control","WSH"),
  c("Control","Nutrition"),
  c("Control","Nutrition + WSH")
)
```

# unadjusted estimates (paired t-test)
```{r}
diff.h1 <- t(sapply(h1.contrasts,washb_ITT.unadj,Y=ad$laz,tr=ad$tr,strat=ad$block,measure="RD"))
rownames(diff.h1) <- c("Water v C","Sanitation v C","Handwashing v C","WSH v C","Nutrition v C","Nutrition + WSH v C")
print(diff.h1)
```

#Unadjusted GLM
```{r}
print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Water"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Sanitation"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Handwashing"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","WSH"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Nutrition"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=NULL,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Nutrition + WSH"), family="gaussian")))
```


#Adjusted GLM
```{r}

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Water"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Sanitation"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Handwashing"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","WSH"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Nutrition"), family="gaussian")))

print((washb_glm(Y=ad$laz,tr=ad$tr,pair=ad$block, W=Ws,forcedW=NULL, id=ad$clusterid, contrast=c("Control","Nutrition + WSH"), family="gaussian")))
```
