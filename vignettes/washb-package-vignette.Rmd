---
title: "Wash Benefits internal R package functions"
author: "Andrew Mertens"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{washb-package-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```



<a id="id1"></a>  

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 200)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## WASH Benefits diarrheal disease outcome analysis using R package functions  
### Calculate adjusted differences in diarrheal disease between treatment arms for H1 and H2  
####Input file:
 * washb-bangladesh-diar.csv  
 
##List and description of the functions documented in this vignette:  
 * washb_prescreen  
 * washb_permute 
 * washb_glm  
 * washb_means  
 * sandwichSE 
 * washb_ttest  
 * washb_mh
 * washb_prescreen  
 
 
# Load in necessary functions
#Load in Package:
To be filled in

```{r  results = "hide"}
rm(list=ls())
#No need without SL analysis
#library(tmle)
#library(SuperLearner)
```

, echo=FALSE, results = "hide"
```{r washb_bd_enrol}
library(washb)
#load("data/washb_bd_enrol.rda")
#bd <- washb_bd_enrol
#data(washb_bd_diar)
#head(washb_bd_enrol)
#head(bd)
  # drop svydate and month because they are superceded in the child level diarrhea data
  #bd$svydate <- NULL
  #bd$month <- NULL

#load("data/washb_bd_diar.rda")
#d <- washb_bd_diar

```


### merge the baseline dataset to the follow-up dataset
#```{r  results = "hide"}
ad <- merge(bd,d,by=c("dataid","clusterid","block","tr"),all.x=F,all.y=T)
dim(d)
dim(ad)

```

### subset to the relevant measurement
### Year 1 or Year 2

#```{r echo=FALSE, results = "hide", tidy=TRUE}
table(ad$svy)
ad <- subset(ad,svy==1|svy==2)
dim(ad)
```

### subset the diarrhea to children <36 mos at enrollment
### (exlude new births that are not target children)

#```{r echo=FALSE}

dim(ad)
table(ad$sibnewbirth)
ad <- subset(ad,sibnewbirth==0)
dim(ad)
table(ad$gt36mos)
ad <- subset(ad,gt36mos==0)
```

### Exclude children with missing data
#```{r echo=FALSE}

table(ad$tchild,is.na(ad$diar7d),ad$svy)
ad <- subset(ad,!is.na(ad$diar7d))
```

###Re-order the tr factor for convenience
#```{r  results = "hide"}
ad$tr <- factor(ad$tr,levels=c("Control","Water","Sanitation","Handwashing","WSH","Nutrition","Nutrition + WSH"))
```
###Ensure that month is coded as a factor
#```{r  results = "hide"}
ad$month <- factor(ad$month)
```

###Sort the data for perfect replication with jade on the V-fold cross-validation
#```{r  results = "hide"}
ad <- ad[order(ad$block,ad$clusterid,ad$dataid,ad$childid),]
```

#Function: wasb_prescreen  
Select covariates with univariate associations with the outcome of P<0.2 based on a likelihood ratio test.

(Excluded because only measured in target children: birthord)  
(Dropped due to too many missing values: asset_clock, momheight)  

####First, subset the desired variables
#```{r  echo=FALSE}

Ws <- subset(ad,select=c("fracode","month","agedays","sex","momage","momedu","momheight","hfiacat","Nlt18","Ncomp","watmin","elec","floor","walls","roof","asset_wardrobe","asset_table","asset_chair","asset_khat","asset_chouki","asset_tv","asset_refrig","asset_bike","asset_moto","asset_sewmach","asset_mobile"))
```

####Run the washb_prescreen function
#```{r}
washb_prescreen(Y=ad$diar7d,Ws,family="poisson")

```

#---------------------------------------
# Estimate adjusted mean differences
#---------------------------------------
#---------------------------------------
# H1: Each intervention arm vs. Control
#---------------------------------------
h1.contrasts <- list(
  c("Control","Water"),
  c("Control","Sanitation"),
  c("Control","Handwashing"),
  c("Control","WSH"),
  c("Control","Nutrition"),
  c("Control","Nutrition + WSH")
)

# unadjusted estimates (mantel-haenszel)
diff.h1 <- t(sapply(h1.contrasts,ITT.unadj,Y=ad$diar7d,tr=ad$tr,strat=ad$block,binomial=TRUE,measure="RD"))
rownames(diff.h1) <- c("Water v C","Sanitation v C","Handwashing v C","WSH v C","Nutrition v C","Nutrition + WSH v C")

# adjusted estimates (tmle)
cwfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Water"),seed=3902288)
csfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Sanitation"),seed=6125274)
chfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Handwashing"),seed=4499261)
cwshfit  <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","WSH"),seed=4545085)
cnfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Nutrition"),seed=1964134)
cwshnfit <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.67,0.33),contrast=c("Control","Nutrition + WSH"),seed=4397157)

# pull out the estimates from the tmle objects and summarize them in a matrix
tmle.summary.rd <- function(x) {
  res <- c(x$estimates$ATE$psi,x$estimates$ATE$CI[1],x$estimates$ATE$CI[2],x$estimates$ATE$pvalue)
  names(res) <- c("rd","ci.lb","ci.ub","p")
  return(res)
}
tmle.summary.pr <- function(x) {
  res <- c(x$estimates$RR$psi,x$estimates$RR$CI[1],x$estimates$RR$CI[2],x$estimates$RR$pvalue)
  names(res) <- c("pr","ci.lb","ci.ub","p")
  return(res)
}

tmle.h1 <- list(cwfit,csfit,chfit,cwshfit,cnfit,cwshnfit)
rd.tmle.h1 <- t(sapply(tmle.h1,tmle.summary.rd))
pr.tmle.h1 <- t(sapply(tmle.h1,tmle.summary.pr))
rownames(rd.tmle.h1) <- rownames(pr.tmle.h1) <- rownames(diff.h1)

# print results
round(diff.h1,4)
round(rd.tmle.h1,4)
round(pr.tmle.h1,4)


#---------------------------------------
# H2: Combined WSH versus single interventions
#---------------------------------------
h2.contrasts <- list(
  c("Water","WSH"),
  c("Sanitation","WSH"),
  c("Handwashing","WSH")
)

# unadjusted estimates (paired t-test)
diff.h2 <- t(sapply(h2.contrasts,ITT.unadj,Y=ad$diar7d,tr=ad$tr,strat=ad$block,binomial=TRUE,measure="RD"))
rownames(diff.h2) <- c("WSH v Water","WSH v Sanitation","WSH v Handwashing")

# adjusted estimates (tmle)
wshwfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("Water","WSH"),seed=8440041)
wshhfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("Handwashing","WSH"),seed=1948434)
wshsfit    <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("Sanitation","WSH"),seed=1289364)

tmle.h2 <- list(wshwfit,wshsfit,wshhfit)
rd.tmle.h2 <- t(sapply(tmle.h2,tmle.summary.rd))
pr.tmle.h2 <- t(sapply(tmle.h2,tmle.summary.pr))
rownames(rd.tmle.h2) <- rownames(pr.tmle.h2) <- rownames(diff.h2)

# print results
round(diff.h2,4)
round(rd.tmle.h2,4)
round(pr.tmle.h2,4)

#---------------------------------------
# H3: WSH+Nutrition vs. WSH or Nutrition alone
# CURRENTLY COMMENTED OUT TO SAVE COMPUTING
# TIME B/C NOT PRE-SPECIFIED for diarrhea
#---------------------------------------
# h3.contrasts <- list(
#   c("WSH","Nutrition + WSH"),
#   c("Nutrition","Nutrition + WSH")
# )
# 
# # unadjusted estimates (paired t-test)
# diff.h3 <- t(sapply(h3.contrasts,ITT.unadj,Y=ad$diar7d,tr=ad$tr,strat=ad$block))
# rownames(diff.h3) <- c("Nutrition + WSH v Nutrition","Nutrition + WSH v WSH")
# 
# # adjusted estimates (tmle)
# set.seed(792348)
# wshwshnfit <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("WSH","Nutrition + WSH"))
# nwshnfit   <- ITT.tmle(Y=ad$diar7d,tr=ad$tr,strat=ad$block,W=Ws,id=ad$clusterid,family="binomial",prtr=c(0.5,0.5),contrast=c("Nutrition","Nutrition + WSH"))
# 
# tmle.h3 <- list(nwshnfit,wshwshnfit)
# rd.tmle.h3 <- t(sapply(tmle.h3,tmle.summary.rd))
# rownames(rd.tmle.h3) <- rownames(diff.h3)


#---------------------------------------
# re-name into pre-specified objects
#---------------------------------------

diar_h1_rd_adj <- rd.tmle.h1
diar_h2_rd_adj <- rd.tmle.h2
# diar_h3_rd_adj <- rd.tmle.h3

diar_h1_pr_adj <- pr.tmle.h1
diar_h2_pr_adj <- pr.tmle.h2
# diar_h3_pr_adj <- pr.tmle.h3

#---------------------------------------
# Print and save results
#---------------------------------------
diar_h1_rd_adj

diar_h2_rd_adj

diar_h1_pr_adj

diar_h2_pr_adj



# add 'b' suffix for comparison with jade
diar_h1_rd_adj_b <- diar_h1_rd_adj
diar_h2_rd_adj_b <- diar_h2_rd_adj
diar_h1_pr_adj_b <- diar_h1_pr_adj
diar_h2_pr_adj_b <- diar_h2_pr_adj
rm(diar_h1_rd_adj,diar_h2_rd_adj,diar_h1_pr_adj,diar_h2_pr_adj)

# save everything except the datasets themselves
# that way we have all of the block-specific estimates if needed for plotting or additional stats
rm(list=c("d","ad"))
save.image(file="~/dropbox/wbb-primary-analysis/results/raw/ben/bangladesh-diar-adj-ben.RData")



```

